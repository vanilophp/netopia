# Netopia Payment Gateway Support for Vanilo

[![Tests](https://img.shields.io/github/actions/workflow/status/vanilophp/netopia/tests.yml?branch=master&style=flat-square)](https://github.com/vanilophp/netopia/actions?query=workflow%3Atests)
[![Packagist Stable Version](https://img.shields.io/packagist/v/vanilo/netopia.svg?style=flat-square&label=stable)](https://packagist.org/packages/vanilo/netopia)
[![StyleCI](https://styleci.io/repos/329267213/shield?branch=master)](https://styleci.io/repos/329267213)
[![Packagist downloads](https://img.shields.io/packagist/dt/vanilo/netopia.svg?style=flat-square)](https://packagist.org/packages/vanilo/netopia)
[![MIT Software License](https://img.shields.io/badge/license-MIT-blue.svg?style=flat-square)](LICENSE)

This library implements the [Netopia Payment Processor](https://netopia-payments.com) for
[Vanilo Payments](https://vanilo.io/docs/master/payments).

Being a [Concord Module](https://konekt.dev/concord/1.x/modules) it is intended to be used by
Laravel Applications.

## IMPORTANT

Netopia uses the RC4 cipher algo for its messages. In recent (~2023) OpenSSL installations this cipher
is disabled by default.

In order to use this library **you must enable legacy options for OpenSSL 3**:

1. Find and open the file at /etc/ssl/openssl.cnf
2. At the `[default_sect]` section change it to the following:
    ```ini
    [default_sect]
    activate = 1
    [legacy_sect]
    activate = 1
    ```
3. Then find the `[provider_sect]` and change it to the following:
    ```ini
    [provider_sect]
    default = default_sect
    legacy = legacy_sect
    ```

## Documentation

Refer to the markdown files in the [docs](docs/) folder.

## To-do

The library works but there's space for improvement.

### 1. Recurring Payments

It's completely untested at the moment, thus it may or may not work

### 2. Usage of Loyalty Points

It's completely untested at the moment.

### 3. Add More Specific Error Test Cases

- Use the test cards from the doc to generate scenarios for various failed cases
- Catch the XML responses, add them to unit tests and check them specifically

**Cases**:

- [X] Successful Payment. Covered.
- [X] Expired Card. Covered.
- [X] Partial refund. Covered.
- [X] Complete refund. Covered.
- [X] Transaction Declined. Covered.
- [ ] Insufficient funds. No unit test coverage.
- [ ] Incorrect CVV2/CCV. No unit test coverage.
- [ ] Transaction not permitted (eg. card not enrolled). No unit test coverage.
- [ ] Risky card detected (eg. stolen card). No unit test coverage.
- [ ] Error at the origin Bank (eg. can't connect to the Bank). No unit test coverage.

### 4. Test With Real Netopia Keys

During tests, I created a test account at Netopia and generated test keys, to establish
close to real life scenarios during unit tests.

There were issues with simulating the encrypted messages generated by Netopia using the actual keys.
The tests use a locally generated RSA key pair for this functionality. It seems to do the job, but
if we find to cause of the issue, let's use actual Netopia keys.

### 5. Record More Response Details

Netopia returns the following data which we should record locally:

- `pan_masked` (card number digits eg. 4****2806)

### 6. SMS Payment

Netopia supports SMS payments. Likely won't be implemented here as it's more for micro payments,
but hell, who knows ðŸ¤·

### 7. Refunds

Netopia supports direct credit (refund) and capture operations via its [SOAP API](http://www.mobilpay.ro/api/merchant?wsdl)
